<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç DEBUG Transporteurs Shopware</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f5f5f5; }
        .code {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .highlight { background: yellow; padding: 2px 5px; font-weight: bold; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2.5em; font-weight: bold; }
        .stat-label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG Transporteurs Shopware</h1>
        <p style="color: #666; margin-bottom: 40px;">Outil pour voir EXACTEMENT ce que Shopware envoie comme noms de transporteurs</p>

        <div class="section">
            <h2>üîê Configuration Shopware</h2>
            <label>URL Shopware</label>
            <input type="text" id="url" value="https://fr.hau.vonaffenfels.de" placeholder="https://votre-shop.com">
            
            <label>API Username</label>
            <input type="text" id="username" value="odoosync">
            
            <label>API Key</label>
            <input type="password" id="apikey" value="T8dbJHHQGtrJtG4kGXuxFW2Z4EM7uDMD5cyhlkWf">
            
            <button onclick="debugTransporteurs()" id="debugBtn">
                üîç ANALYSER LES TRANSPORTEURS
            </button>
        </div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        async function debugTransporteurs() {
            const url = document.getElementById('url').value.trim();
            const username = document.getElementById('username').value.trim();
            const apikey = document.getElementById('apikey').value.trim();
            const btn = document.getElementById('debugBtn');
            const resultsDiv = document.getElementById('results');

            if (!url || !username || !apikey) {
                alert('‚ö†Ô∏è Remplissez tous les champs !');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Analyse en cours...';
            resultsDiv.style.display = 'none';

            try {
                // Appel API Shopware
                const response = await fetch(`${url}/api/orders?limit=100`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Digest username="' + username + '"',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }

                const result = await response.json();
                const orders = result.data || [];

                // Analyser les transporteurs
                const transporteurs = new Map();
                const ordersData = [];

                orders.forEach(order => {
                    const dispatchName = order.dispatch?.name || '[VIDE]';
                    const dispatchId = order.dispatch?.id || 'N/A';
                    
                    if (!transporteurs.has(dispatchName)) {
                        transporteurs.set(dispatchName, {
                            count: 0,
                            id: dispatchId,
                            orders: []
                        });
                    }
                    
                    const info = transporteurs.get(dispatchName);
                    info.count++;
                    info.orders.push(order.number || 'NO_NUMBER');

                    ordersData.push({
                        number: order.number || 'NO_NUMBER',
                        date: order.orderTime || '',
                        dispatch: dispatchName,
                        dispatchId: dispatchId
                    });
                });

                // Afficher les r√©sultats
                let html = '<h2>üìä R√âSULTATS DE L\'ANALYSE</h2>';

                // Stats
                html += '<div class="stats">';
                html += `<div class="stat-card"><div class="stat-number">${orders.length}</div><div class="stat-label">Commandes analys√©es</div></div>`;
                html += `<div class="stat-card"><div class="stat-number">${transporteurs.size}</div><div class="stat-label">Transporteurs diff√©rents</div></div>`;
                html += '</div>';

                // Liste des transporteurs uniques
                html += '<h3>üöö Transporteurs trouv√©s (NOMS EXACTS) :</h3>';
                html += '<div class="code">';
                Array.from(transporteurs.entries())
                    .sort((a, b) => b[1].count - a[1].count)
                    .forEach(([name, info]) => {
                        html += `<span class="highlight">"${name}"</span> (ID: ${info.id}) ‚Üí ${info.count} commandes\n`;
                    });
                html += '</div>';

                // Recommandations mapping
                html += '<h3>üí° Configuration recommand√©e pour Odoo :</h3>';
                html += '<div class="code" style="background: #e8f5e9;">';
                html += '<strong>Dans l\'onglet "Mapping Transporteurs" d\'Odoo, cr√©ez :</strong>\n\n';
                
                const uniqueNames = Array.from(transporteurs.keys()).filter(n => n !== '[VIDE]');
                uniqueNames.forEach(name => {
                    // Extraire un mot-cl√© simple
                    let keyword = name.toLowerCase();
                    if (keyword.match(/^\d+\./)) {
                        keyword = keyword.split('.')[0] + '.';
                    } else if (keyword.includes('colissimo')) {
                        keyword = keyword.includes('point') || keyword.includes('relais') ? 'colissimo relais' : 'colissimo domicile';
                    } else if (keyword.includes('mondial')) {
                        keyword = 'mondial';
                    } else if (keyword.includes('tnt')) {
                        keyword = 'tnt';
                    }
                    
                    html += `Nom Shopware: <span class="highlight">${keyword}</span>\n`;
                    html += `M√©thode Odoo: [S√©lectionner votre m√©thode pour "${name}"]\n\n`;
                });
                html += '</div>';

                // Tableau d√©taill√©
                html += '<h3>üìã D√©tails par commande :</h3>';
                html += '<table>';
                html += '<tr><th>N¬∞ Commande</th><th>Date</th><th>Transporteur (nom exact)</th><th>ID Dispatch</th></tr>';
                
                ordersData.slice(0, 50).forEach(o => {
                    html += `<tr>`;
                    html += `<td>${o.number}</td>`;
                    html += `<td>${o.date.substring(0, 10)}</td>`;
                    html += `<td><strong>${o.dispatch}</strong></td>`;
                    html += `<td>${o.dispatchId}</td>`;
                    html += `</tr>`;
                });
                
                if (ordersData.length > 50) {
                    html += `<tr><td colspan="4" style="text-align: center; color: #999;">... et ${ordersData.length - 50} autres commandes</td></tr>`;
                }
                
                html += '</table>';

                // JSON brut pour copier-coller
                html += '<h3>üìÑ Donn√©es JSON (pour debug technique) :</h3>';
                html += '<div class="code" style="max-height: 300px; overflow-y: auto;">';
                html += JSON.stringify(Array.from(transporteurs.entries()), null, 2);
                html += '</div>';

                resultsDiv.innerHTML = html;
                resultsDiv.style.display = 'block';

            } catch (error) {
                alert(`‚ùå Erreur: ${error.message}`);
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç ANALYSER LES TRANSPORTEURS';
            }
        }

        // Auto-remplissage si credentials dans localStorage
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('shopware_config');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('url').value = config.url || '';
                document.getElementById('username').value = config.username || '';
                document.getElementById('apikey').value = config.apikey || '';
            }
        });
    </script>
</body>
</html>
