<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopware ‚Üí Odoo - All-in-One v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 40px; }
        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }
        .step.active { background: #e7f1ff; border-left-color: #0066ff; }
        .step.completed { background: #d4edda; border-left-color: #28a745; }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .section h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }
        select:focus, input:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; margin-bottom: 10px; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label { color: #666; margin-top: 5px; font-size: 0.9em; }
        .hidden { display: none; }
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .upload-zone:hover { background: #f8f9fa; border-color: #764ba2; }
        .upload-zone.has-file { border-color: #28a745; background: #d4edda; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f8f9fa; }
        small { display: block; margin-top: 5px; color: #666; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Shopware ‚Üí Odoo</h1>
        <p class="subtitle">Solution compl√®te : Export, Mapping et Import</p>

        <div id="alerts"></div>

        <!-- Progression -->
        <div class="steps">
            <div class="step" id="step1">
                <span class="step-number">1</span>
                <strong>Configuration</strong>
            </div>
            <div class="step" id="step2">
                <span class="step-number">2</span>
                <strong>Export Shopware</strong>
            </div>
            <div class="step" id="step3">
                <span class="step-number">3</span>
                <strong>Mapping Odoo</strong>
            </div>
            <div class="step" id="step4">
                <span class="step-number">4</span>
                <strong>Import/Download</strong>
            </div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="form-group">
                <label for="apiUrl">URL API Vercel</label>
                <input type="text" id="apiUrl" placeholder="https://shopware-odoo-api.vercel.app/api">
            </div>
            <button class="btn btn-secondary" onclick="testConnection()">
                üîç Tester Shopware
            </button>
        </div>

        <!-- Export Shopware -->
        <div class="section">
            <h2>üì¶ Export Shopware</h2>
            <div class="form-group">
                <label for="statusFilter">Statut des commandes</label>
                <select id="statusFilter">
                    <option value="">Tous les statuts</option>
                    <option value="0">üü° En attente / Open</option>
                    <option value="1">üîµ En cours</option>
                    <option value="2">üü¢ Termin√©e</option>
                    <option value="3">üî¥ Annul√©e</option>
                </select>
            </div>
            <button class="btn" onclick="exportShopware()" id="exportBtn">
                üöÄ Exporter de Shopware
            </button>
            <div id="shopwareStats" class="hidden">
                <div class="stats" id="statsShopware"></div>
            </div>
        </div>

        <!-- Mapping -->
        <div class="section" id="mappingSection" style="display: none;">
            <h2>üó∫Ô∏è Mapping avec base Odoo</h2>
            <div class="upload-zone" id="odooUploadZone" onclick="document.getElementById('odooFile').click()">
                <p id="odooUploadText">üìÇ Cliquez pour charger votre export Odoo<br>(Excel ou CSV)</p>
                <input type="file" id="odooFile" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <div id="columnSelectors" class="hidden" style="margin-top: 20px;">
                <div class="alert alert-info">
                    ‚úÖ Fichier charg√© ! S√©lectionnez les bonnes colonnes :
                </div>
                <div class="form-group">
                    <label for="odooRefColumnSelect">Colonne "R√©f√©rence interne Odoo"</label>
                    <select id="odooRefColumnSelect" onchange="updateMappingPreview()">
                        <option value="">-- S√©lectionnez --</option>
                    </select>
                    <small>Ex: default_code, R√©f√©rence interne, Internal Reference</small>
                </div>
                <div class="form-group">
                    <label for="supplierRefColumnSelect">Colonne "Code fournisseur" (codes Shopware)</label>
                    <select id="supplierRefColumnSelect" onchange="updateMappingPreview()">
                        <option value="">-- S√©lectionnez --</option>
                    </select>
                    <small>Ex: Code produit fournisseur, supplier_sku, Vendor Item Number</small>
                </div>
                <div id="mappingPreview" class="hidden" style="padding: 15px; background: #fff; border-radius: 10px; margin-top: 15px;">
                    <strong>üìã Aper√ßu du mapping (5 premiers):</strong>
                    <table>
                        <thead>
                            <tr>
                                <th>Code Shopware</th>
                                <th style="width: 50px; text-align: center;">‚Üí</th>
                                <th>R√©f√©rence Odoo</th>
                            </tr>
                        </thead>
                        <tbody id="mappingPreviewBody"></tbody>
                    </table>
                </div>
                <button class="btn" onclick="applyMapping()" id="mappingBtn" style="margin-top: 15px;">
                    üó∫Ô∏è Appliquer le mapping
                </button>
            </div>
            <div id="mappingStats" class="hidden">
                <div class="stats" id="statMapping"></div>
            </div>
        </div>

        <!-- Import Odoo -->
        <div class="section" id="importSection" style="display: none;">
            <h2>üì• Import dans Odoo (optionnel)</h2>
            <div class="form-group">
                <label for="odooUrl">URL Odoo</label>
                <input type="text" id="odooUrl" placeholder="https://votre-odoo.odoo.com">
            </div>
            <div class="form-group">
                <label for="odooDb">Base de donn√©es</label>
                <input type="text" id="odooDb" placeholder="Nom de la base">
            </div>
            <div class="form-group">
                <label for="odooUsername">Login Odoo</label>
                <input type="text" id="odooUsername" placeholder="votre@email.com">
            </div>
            <div class="form-group">
                <label for="odooApiKey">Cl√© API Odoo</label>
                <input type="password" id="odooApiKey" placeholder="Votre cl√© API">
            </div>
            <button class="btn btn-success" onclick="importToOdoo()" id="importBtn">
                üéØ Importer dans Odoo
            </button>
            <div class="progress-bar hidden" id="importProgress">
                <div class="progress-fill" id="importProgressFill"></div>
            </div>
            <div id="importStats" class="hidden">
                <div class="stats" id="statsImport"></div>
            </div>
        </div>

        <!-- T√©l√©chargement -->
        <div class="section hidden" id="downloadSection">
            <h2>üíæ T√©l√©chargement</h2>
            <button class="btn" onclick="downloadExcel()">
                üì• T√©l√©charger le fichier Excel
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let ordersData = [];
        let mappedData = [];
        let odooMapping = {};
        let odooFileData = [];
        let availableColumns = [];

        function showAlert(msg, type = 'info') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = msg;
            alerts.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function setStepActive(n) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                if (i < n) step.classList.add('completed');
                if (i === n) step.classList.add('active');
            }
        }

        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è Entrez l\'URL API', 'error');
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/test-connection`);
                const data = await res.json();
                if (data.success) {
                    showAlert(`‚úÖ Connexion OK ! ${data.total} commandes`, 'success');
                    localStorage.setItem('apiUrl', apiUrl);
                    setStepActive(2);
                } else {
                    showAlert(`‚ùå ${data.error}`, 'error');
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            }
        }

        async function exportShopware() {
            const apiUrl = document.getElementById('apiUrl').value.trim() || localStorage.getItem('apiUrl');
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è Configurez l\'API', 'error');
                return;
            }
            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Export...';
            const statusValue = document.getElementById('statusFilter').value;
            let status = null;
            if (statusValue !== '') status = parseInt(statusValue);
            console.log('Statut:', status, typeof status);
            try {
                const res = await fetch(`${apiUrl}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, limit: 1000 })
                });
                const data = await res.json();
                if (data.success) {
                    ordersData = transformOrders(data.orders);
                    document.getElementById('shopwareStats').classList.remove('hidden');
                    document.getElementById('statsShopware').innerHTML = `
                        <div class="stat-box"><div class="stat-number">${data.filtered}</div><div class="stat-label">Commandes</div></div>
                        <div class="stat-box"><div class="stat-number">${ordersData.length}</div><div class="stat-label">Lignes</div></div>
                    `;
                    document.getElementById('mappingSection').style.display = 'block';
                    document.getElementById('downloadSection').classList.remove('hidden');
                    setStepActive(3);
                    showAlert('‚úÖ Export r√©ussi !', 'success');
                } else {
                    showAlert(`‚ùå ${data.error}`, 'error');
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Exporter de Shopware';
            }
        }

        function transformOrders(orders) {
            const rows = [];
            orders.forEach(o => {
                const num = o.number || o.id || 'NO_NUMBER';
                const date = o.orderTime || '';
                const billing = o.billing || {};
                const customer = o.customer || {};
                const name = `${billing.firstName || ''} ${billing.lastName || ''}`.trim();
                const email = customer.email || '';
                const details = o.details || [];
                details.forEach(d => {
                    rows.push({
                        order_number: num,
                        order_date: date,
                        customer_name: name,
                        customer_email: email,
                        product_ref_shopware: d.articleNumber || '',
                        product_ref_odoo: d.articleNumber || '',
                        product_name: d.articleName || '',
                        quantity: d.quantity || 0,
                        unit_price: d.price || 0,
                        total_price: d.total || 0
                    });
                });
            });
            return rows;
        }

        document.getElementById('odooFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('odooUploadZone').classList.add('has-file');
            document.getElementById('odooUploadText').textContent = `‚úÖ ${file.name}`;
            showAlert('üìä Analyse...', 'info');
            try {
                if (file.name.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        complete: (res) => handleOdooFileLoaded(res.data),
                        error: (err) => showAlert(`‚ùå ${err.message}`, 'error')
                    });
                } else {
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(data);
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    handleOdooFileLoaded(json);
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            }
        });

        function handleOdooFileLoaded(data) {
            if (!data || data.length === 0) {
                showAlert('‚ö†Ô∏è Fichier vide', 'error');
                return;
            }
            odooFileData = data;
            availableColumns = Object.keys(data[0]);
            console.log('Colonnes:', availableColumns);
            const s1 = document.getElementById('odooRefColumnSelect');
            const s2 = document.getElementById('supplierRefColumnSelect');
            s1.innerHTML = '<option value="">-- S√©lectionnez --</option>';
            s2.innerHTML = '<option value="">-- S√©lectionnez --</option>';
            availableColumns.forEach(col => {
                s1.innerHTML += `<option value="${col}">${col}</option>`;
                s2.innerHTML += `<option value="${col}">${col}</option>`;
            });
            autoSelectColumns(s1, s2);
            document.getElementById('columnSelectors').classList.remove('hidden');
            showAlert(`‚úÖ ${data.length} produits | ${availableColumns.length} colonnes`, 'success');
        }

        function autoSelectColumns(s1, s2) {
            const p1 = ['default_code', 'internal', 'r√©f√©rence', 'reference'];
            const p2 = ['supplier', 'vendor', 'fournisseur', 'code produit'];
            availableColumns.forEach(col => {
                const lower = col.toLowerCase();
                if (!s1.value) {
                    for (let p of p1) {
                        if (lower.includes(p)) {
                            s1.value = col;
                            break;
                        }
                    }
                }
                if (!s2.value) {
                    for (let p of p2) {
                        if (lower.includes(p)) {
                            s2.value = col;
                            break;
                        }
                    }
                }
            });
            updateMappingPreview();
        }

        function updateMappingPreview() {
            const c1 = document.getElementById('odooRefColumnSelect').value;
            const c2 = document.getElementById('supplierRefColumnSelect').value;
            if (!c1 || !c2) return;
            const body = document.getElementById('mappingPreviewBody');
            body.innerHTML = '';
            let count = 0;
            for (let i = 0; i < Math.min(5, odooFileData.length); i++) {
                const row = odooFileData[i];
                const sup = String(row[c2] || '').replace('.0', '').trim();
                const odoo = String(row[c1] || '').replace('.0', '').trim();
                if (sup && odoo) {
                    body.innerHTML += `<tr><td>${sup}</td><td style="text-align:center;">‚Üí</td><td>${odoo}</td></tr>`;
                    count++;
                }
            }
            if (count > 0) {
                document.getElementById('mappingPreview').classList.remove('hidden');
            } else {
                showAlert('‚ö†Ô∏è Aucune correspondance', 'warning');
            }
        }

        function applyMapping() {
            const c1 = document.getElementById('odooRefColumnSelect').value;
            const c2 = document.getElementById('supplierRefColumnSelect').value;
            if (!c1 || !c2) {
                showAlert('‚ö†Ô∏è S√©lectionnez les deux colonnes', 'error');
                return;
            }
            if (odooFileData.length === 0) {
                showAlert('‚ö†Ô∏è Aucune donn√©e', 'error');
                return;
            }
            odooMapping = {};
            let count = 0;
            odooFileData.forEach(row => {
                const sup = String(row[c2] || '').replace('.0', '').trim();
                const odoo = String(row[c1] || '').replace('.0', '').trim();
                if (sup && odoo) {
                    odooMapping[sup] = odoo;
                    count++;
                }
            });
            console.log(`Mapping: ${count} entr√©es`);
            console.log('Exemples:', Object.entries(odooMapping).slice(0, 5));
            if (count === 0) {
                showAlert('‚ùå Aucun mapping cr√©√©', 'error');
                return;
            }
            let mapped = 0, unmapped = 0;
            mappedData = ordersData.map(row => {
                const shopRef = String(row.product_ref_shopware).trim();
                if (odooMapping[shopRef]) {
                    row.product_ref_odoo = odooMapping[shopRef];
                    mapped++;
                } else {
                    unmapped++;
                }
                return row;
            });
            document.getElementById('mappingStats').classList.remove('hidden');
            document.getElementById('statMapping').innerHTML = `
                <div class="stat-box"><div class="stat-number">${mapped}</div><div class="stat-label">Mapp√©s</div></div>
                <div class="stat-box"><div class="stat-number">${unmapped}</div><div class="stat-label">Non mapp√©s</div></div>
                <div class="stat-box"><div class="stat-number">${count}</div><div class="stat-label">Base</div></div>
            `;
            document.getElementById('importSection').style.display = 'block';
            setStepActive(4);
            showAlert(`‚úÖ Mapping OK: ${mapped} trouv√©s`, 'success');
        }

        function downloadExcel() {
            const data = mappedData.length > 0 ? mappedData : ordersData;
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Commandes');
            const ts = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
            const name = mappedData.length > 0 ? `commandes_odoo_mappe_${ts}.xlsx` : `commandes_odoo_${ts}.xlsx`;
            XLSX.writeFile(wb, name);
            showAlert('üíæ T√©l√©charg√© !', 'success');
        }

        async function importToOdoo() {
            const apiUrl = document.getElementById('apiUrl').value.trim() || localStorage.getItem('apiUrl');
            const odooUrl = document.getElementById('odooUrl').value.trim();
            const odooDb = document.getElementById('odooDb').value.trim();
            const odooUsername = document.getElementById('odooUsername').value.trim();
            const odooApiKey = document.getElementById('odooApiKey').value.trim();
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è API non configur√©e', 'error');
                return;
            }
            if (!odooUrl || !odooDb || !odooUsername || !odooApiKey) {
                showAlert('‚ö†Ô∏è Compl√©tez tous les champs Odoo', 'error');
                return;
            }
            if (mappedData.length === 0) {
                showAlert('‚ö†Ô∏è Aucune donn√©e √† importer', 'error');
                return;
            }
            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Import...';
            const prog = document.getElementById('importProgress');
            const fill = document.getElementById('importProgressFill');
            prog.classList.remove('hidden');
            fill.style.width = '30%';
            try {
                const res = await fetch(`${apiUrl}/import-to-odoo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orders: mappedData,
                        odoo_url: odooUrl,
                        odoo_db: odooDb,
                        odoo_username: odooUsername,
                        odoo_api_key: odooApiKey
                    })
                });
                fill.style.width = '70%';
                const data = await res.json();
                fill.style.width = '100%';
                if (data.success) {
                    document.getElementById('importStats').classList.remove('hidden');
                    document.getElementById('statsImport').innerHTML = `
                        <div class="stat-box"><div class="stat-number">${data.imported}</div><div class="stat-label">Cr√©√©es</div></div>
                        <div class="stat-box"><div class="stat-number">${data.errors_count}</div><div class="stat-label">Erreurs</div></div>
                        <div class="stat-box"><div class="stat-number">${data.total_orders}</div><div class="stat-label">Total</div></div>
                    `;
                    let msg = `‚úÖ Import: ${data.imported}/${data.total_orders} commandes`;
                    if (data.errors_count > 0) {
                        msg += `<br><br>‚ö†Ô∏è ${data.errors_count} erreur(s):<br>`;
                        msg += data.errors.slice(0, 5).join('<br>');
                        if (data.errors_count > 5) msg += `<br>... +${data.errors_count - 5}`;
                    }
                    showAlert(msg, data.errors_count === 0 ? 'success' : 'warning');
                } else {
                    showAlert(`‚ùå ${data.error}`, 'error');
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üéØ Importer dans Odoo';
                setTimeout(() => {
                    prog.classList.add('hidden');
                    fill.style.width = '0%';
                }, 2000);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('apiUrl');
            if (saved) document.getElementById('apiUrl').value = saved;
            setStepActive(1);
        });
    </script>
</body>
</html>
