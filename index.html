<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopware ‚Üí Odoo - Version Finale</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 40px; }
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .section h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .form-group { margin-bottom: 20px; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }
        select:focus, input:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); }
        .alert {
            padding: 15px 50px 15px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.3s;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .alert-close {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.1);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .alert-close:hover {
            background: rgba(0,0,0,0.2);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label { color: #666; margin-top: 5px; font-size: 0.9em; }
        .hidden { display: none; }
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .upload-zone:hover { background: #f8f9fa; border-color: #764ba2; }
        .upload-zone.has-file { border-color: #28a745; background: #d4edda; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f8f9fa; }
        small { display: block; margin-top: 5px; color: #666; font-size: 0.85em; }
        .debug-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Shopware ‚Üí Odoo</h1>
        <p class="subtitle">Version Finale - Export par Date & Statut</p>

        <div id="alerts"></div>

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration API</h2>
            <div class="form-group">
                <label for="apiUrl">URL API Vercel</label>
                <input type="text" id="apiUrl" placeholder="https://shopware-odoo-api.vercel.app/api">
            </div>
            <button class="btn btn-secondary" onclick="testConnection()">
                üîç Tester Shopware
            </button>
            <button class="btn btn-warning" onclick="debugStatuses()">
                üêõ Debug Statuts (voir quels statuts existent)
            </button>
            <div id="debugInfo" class="debug-box hidden"></div>
        </div>

        <!-- Filtres Export -->
        <div class="section">
            <h2>üì¶ Filtres d'Export Shopware</h2>
            
            <div class="form-group">
                <label>üóìÔ∏è P√©riode (optionnel)</label>
                <div class="form-row">
                    <div>
                        <input type="date" id="dateFrom" placeholder="Date de d√©but">
                        <small>Date de d√©but</small>
                    </div>
                    <div>
                        <input type="date" id="dateTo" placeholder="Date de fin">
                        <small>Date de fin</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="statusFilter">üìä Statut (optionnel)</label>
                <select id="statusFilter">
                    <option value="">Tous les statuts</option>
                    <option value="Open">Open (Ouvert)</option>
                    <option value="Completely delivered">Completely delivered (Livr√©)</option>
                    <option value="NOT IN USE-In process">En cours</option>
                    <option value="NOT IN USE-Completed">Compl√©t√©</option>
                    <option value="NOT IN USE-Cancelled/rejected">Annul√©</option>
                    <option value="NOT IN USE-Ready for delivery">Pr√™t √† livrer</option>
                </select>
                <small>üí° Utilisez "Debug Statuts" pour voir tous les statuts disponibles</small>
            </div>

            <button class="btn" onclick="exportShopware()" id="exportBtn">
                üöÄ Exporter de Shopware
            </button>

            <div id="shopwareStats" class="hidden">
                <div class="stats" id="statsShopware"></div>
            </div>
        </div>

        <!-- Mapping -->
        <div class="section hidden" id="mappingSection">
            <h2>üó∫Ô∏è Mapping avec base Odoo</h2>
            <div class="upload-zone" id="odooUploadZone" onclick="document.getElementById('odooFile').click()">
                <p id="odooUploadText">üìÇ Cliquez pour charger votre export Odoo<br>(Excel ou CSV)</p>
                <input type="file" id="odooFile" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <div id="columnSelectors" class="hidden" style="margin-top: 20px;">
                <div class="alert alert-info">
                    ‚úÖ Fichier charg√© ! S√©lectionnez les colonnes :
                </div>
                <div class="form-group">
                    <label for="odooRefColumnSelect">Colonne "R√©f√©rence interne Odoo"</label>
                    <select id="odooRefColumnSelect" onchange="updateMappingPreview()">
                        <option value="">-- S√©lectionnez --</option>
                    </select>
                    <small>Ex: default_code, R√©f√©rence interne</small>
                </div>
                <div class="form-group">
                    <label for="supplierRefColumnSelect">Colonne "Code fournisseur"</label>
                    <select id="supplierRefColumnSelect" onchange="updateMappingPreview()">
                        <option value="">-- S√©lectionnez --</option>
                    </select>
                    <small>Ex: Code produit fournisseur, supplier_sku</small>
                </div>
                <div id="mappingPreview" class="hidden" style="padding: 15px; background: #fff; border-radius: 10px; margin-top: 15px;">
                    <strong>üìã Aper√ßu :</strong>
                    <table>
                        <thead>
                            <tr>
                                <th>Code Shopware</th>
                                <th style="width: 50px; text-align: center;">‚Üí</th>
                                <th>R√©f√©rence Odoo</th>
                            </tr>
                        </thead>
                        <tbody id="mappingPreviewBody"></tbody>
                    </table>
                </div>
                <button class="btn" onclick="applyMapping()" style="margin-top: 15px;">
                    üó∫Ô∏è Appliquer le mapping
                </button>
            </div>
            <div id="mappingStats" class="hidden">
                <div class="stats" id="statMapping"></div>
            </div>
        </div>

        <!-- T√©l√©chargement -->
        <div class="section hidden" id="downloadSection">
            <h2>üíæ T√©l√©chargement</h2>
            <button class="btn" onclick="downloadExcel()">
                üì• T√©l√©charger Excel
            </button>
        </div>

        <!-- Import Odoo -->
        <div class="section hidden" id="importSection">
            <h2>üì• Import direct dans Odoo (optionnel)</h2>
            
            <div class="form-group">
                <label for="odooUrl">URL Odoo</label>
                <input type="text" id="odooUrl" placeholder="https://votre-odoo.odoo.com">
            </div>

            <div class="form-group">
                <label for="odooDb">Base de donn√©es</label>
                <input type="text" id="odooDb" placeholder="Nom de la base">
            </div>

            <div class="form-group">
                <label for="odooUsername">Login Odoo</label>
                <input type="text" id="odooUsername" placeholder="votre@email.com">
            </div>

            <div class="form-group">
                <label for="odooApiKey">Cl√© API Odoo</label>
                <input type="password" id="odooApiKey" placeholder="Votre cl√© API">
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">‚öôÔ∏è Options avanc√©es</h3>

            <div class="form-group">
                <label for="orderTag">√âtiquette pour les commandes E-shop</label>
                <input type="text" id="orderTag" placeholder="E-shop" value="E-shop Shopware">
                <small>Toutes les commandes import√©es auront cette √©tiquette</small>
            </div>

            <div class="form-group">
                <label for="defaultCarrier">Transporteur par d√©faut (ID Odoo)</label>
                <input type="number" id="defaultCarrier" placeholder="Ex: 1">
                <small>Laissez vide si aucun. Trouvez l'ID dans Odoo ‚Üí Inventaire ‚Üí Configuration ‚Üí Transporteurs</small>
            </div>

            <div class="form-group">
                <label for="defaultWarehouse">Entrep√¥t par d√©faut (ID Odoo)</label>
                <input type="number" id="defaultWarehouse" placeholder="Ex: 1">
                <small>Laissez vide pour l'entrep√¥t par d√©faut</small>
            </div>

            <div class="form-group">
                <label for="orderNote">Note interne automatique</label>
                <input type="text" id="orderNote" placeholder="Ex: Commande import√©e depuis Shopware">
                <small>Cette note appara√Ætra sur toutes les commandes</small>
            </div>

            <div class="form-group">
                <label for="orderPrefix">Pr√©fixe pour les num√©ros de commande</label>
                <input type="text" id="orderPrefix" placeholder="Ex: ESHOP" value="ESHOP">
                <small>Les commandes seront cr√©√©es avec ce pr√©fixe (ex: ESHOP/2026/00001 au lieu de WH/ESHOP/00007)</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoConfirm" checked style="width: auto; margin-right: 10px;">
                    Confirmer automatiquement les commandes (passer de Devis ‚Üí Commande)
                </label>
                <small>Si coch√©, les commandes seront directement confirm√©es et pr√™tes pour le picking</small>
            </div>

            <button class="btn btn-success" onclick="importToOdoo()" id="importBtn">
                üéØ Importer dans Odoo
            </button>

            <div class="progress-bar hidden" id="importProgress" style="margin-top: 20px;">
                <div class="progress-fill" id="importProgressFill"></div>
            </div>

            <div id="importStats" class="hidden" style="margin-top: 20px;">
                <div class="stats" id="statsImport"></div>
            </div>

            <div id="importReport" class="hidden" style="margin-top: 30px;">
                <h3>üìã Rapport d'import d√©taill√©</h3>
                
                <div id="successSection" class="hidden" style="margin-top: 20px;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>‚úÖ Commandes cr√©√©es avec succ√®s</strong>
                    </div>
                    <table id="successTable">
                        <thead>
                            <tr>
                                <th>N¬∞ Commande</th>
                                <th>ID Odoo</th>
                                <th>Client</th>
                                <th>Lignes</th>
                                <th>Produits non trouv√©s</th>
                                <th>Lien</th>
                            </tr>
                        </thead>
                        <tbody id="successTableBody"></tbody>
                    </table>
                </div>

                <div id="errorSection" class="hidden" style="margin-top: 20px;">
                    <div style="background: #f8d7da; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>‚ùå Erreurs d'import</strong>
                    </div>
                    <table id="errorTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">N¬∞ Commande</th>
                                <th style="width: 70%;">Erreur</th>
                            </tr>
                        </thead>
                        <tbody id="errorTableBody"></tbody>
                    </table>
                </div>

                <div id="mappingIssuesSection" class="hidden" style="margin-top: 20px;">
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>‚ö†Ô∏è Probl√®mes de mapping (produits non trouv√©s dans Odoo)</strong>
                        <p style="margin-top: 10px; color: #856404; font-size: 0.9em;">
                            Ces produits existent dans Shopware mais n'ont pas √©t√© trouv√©s dans Odoo avec la r√©f√©rence mapp√©e.
                        </p>
                    </div>
                    <table id="mappingTable">
                        <thead>
                            <tr>
                                <th>R√©f√©rence Shopware</th>
                                <th>R√©f√©rence Odoo (mapp√©e)</th>
                                <th>Nom produit</th>
                                <th>Occurences</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody"></tbody>
                    </table>
                    <button class="btn" onclick="downloadMappingIssues()" style="margin-top: 15px;">
                        üì• T√©l√©charger la liste des produits non mapp√©s
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let ordersData = [];
        let mappedData = [];
        let odooMapping = {};
        let odooFileData = [];
        let availableColumns = [];

        function showAlert(msg, type = 'info', duration = 0) {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            // Ic√¥nes selon le type
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            alert.innerHTML = `
                <strong>${icons[type] || ''}</strong> ${msg}
                <button class="alert-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            alerts.appendChild(alert);
            
            // Supprimer automatiquement apr√®s X secondes (si duration > 0)
            if (duration > 0) {
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.style.opacity = '0';
                        alert.style.transform = 'translateX(100%)';
                        setTimeout(() => alert.remove(), 300);
                    }
                }, duration);
            }
            
            // Scroll vers le haut pour voir l'alerte
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è Entrez l\'URL API', 'error');
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/test-connection`);
                const data = await res.json();
                if (data.success) {
                    showAlert(`‚úÖ Connexion OK ! ${data.total} commandes disponibles`, 'success');
                    localStorage.setItem('apiUrl', apiUrl);
                } else {
                    showAlert(`‚ùå ${data.error}`, 'error');
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            }
        }

        async function debugStatuses() {
            const apiUrl = document.getElementById('apiUrl').value.trim() || localStorage.getItem('apiUrl');
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è Configurez l\'API d\'abord', 'error');
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/debug-statuses`);
                const data = await res.json();
                if (data.success) {
                    const debugBox = document.getElementById('debugInfo');
                    let html = `<strong>üìä Statuts trouv√©s dans Shopware (sur ${data.total_orders} commandes):</strong><br><br>`;
                    
                    for (let [status, count] of Object.entries(data.status_counts)) {
                        const examples = data.status_examples[status].join(', ');
                        html += `<strong>Statut ${status}:</strong> ${count} commandes<br>`;
                        html += `Exemples: ${examples}<br><br>`;
                    }
                    
                    debugBox.innerHTML = html;
                    debugBox.classList.remove('hidden');
                    showAlert('‚úÖ Debug termin√© ! Regardez les statuts ci-dessus', 'success');
                } else {
                    showAlert(`‚ùå ${data.error}`, 'error');
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            }
        }

        async function exportShopware() {
            const apiUrl = document.getElementById('apiUrl').value.trim() || localStorage.getItem('apiUrl');
            if (!apiUrl) {
                showAlert('‚ö†Ô∏è Configurez l\'API', 'error');
                return;
            }

            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Export en cours...';

            const statusValue = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            // Envoyer le statut tel quel (nom ou vide)
            let status = statusValue || null;

            console.log('Filtres:', { status, dateFrom, dateTo });

            try {
                const res = await fetch(`${apiUrl}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status, 
                        date_from: dateFrom,
                        date_to: dateTo,
                        limit: 5000
                    })
                });

                const data = await res.json();

                if (data.success) {
                    ordersData = transformOrders(data.orders);
                    
                    // Filtrer par date c√¥t√© client si n√©cessaire
                    if (dateFrom || dateTo) {
                        ordersData = ordersData.filter(order => {
                            const orderDate = new Date(order.order_date);
                            if (dateFrom && orderDate < new Date(dateFrom)) return false;
                            if (dateTo && orderDate > new Date(dateTo + 'T23:59:59')) return false;
                            return true;
                        });
                    }

                    document.getElementById('shopwareStats').classList.remove('hidden');
                    document.getElementById('statsShopware').innerHTML = `
                        <div class="stat-box"><div class="stat-number">${data.filtered}</div><div class="stat-label">Commandes API</div></div>
                        <div class="stat-box"><div class="stat-number">${ordersData.length}</div><div class="stat-label">Lignes finales</div></div>
                    `;
                    
                    document.getElementById('mappingSection').classList.remove('hidden');
                    document.getElementById('downloadSection').classList.remove('hidden');
                    
                    showAlert(`${ordersData.length} lignes export√©es !`, 'success', 3000);
                } else {
                    showAlert(data.error, 'error', 0);
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Exporter de Shopware';
            }
        }

        function transformOrders(orders) {
            const rows = [];
            orders.forEach(o => {
                const num = o.number || o.id || 'NO_NUMBER';
                const date = o.orderTime || '';
                const billing = o.billing || {};
                const customer = o.customer || {};
                const name = `${billing.firstName || ''} ${billing.lastName || ''}`.trim();
                const email = customer.email || '';
                const details = o.details || [];
                details.forEach(d => {
                    rows.push({
                        order_number: num,
                        order_date: date,
                        customer_name: name,
                        customer_email: email,
                        product_ref_shopware: d.articleNumber || '',
                        product_ref_odoo: d.articleNumber || '',
                        product_name: d.articleName || '',
                        quantity: d.quantity || 0,
                        unit_price: d.price || 0,
                        total_price: d.total || 0
                    });
                });
            });
            return rows;
        }

        document.getElementById('odooFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('odooUploadZone').classList.add('has-file');
            document.getElementById('odooUploadText').textContent = `‚úÖ ${file.name}`;
            showAlert('üìä Analyse...', 'info');
            try {
                if (file.name.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        complete: (res) => handleOdooFileLoaded(res.data),
                        error: (err) => showAlert(`‚ùå ${err.message}`, 'error')
                    });
                } else {
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(data);
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    handleOdooFileLoaded(json);
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            }
        });

        function handleOdooFileLoaded(data) {
            if (!data || data.length === 0) {
                showAlert('‚ö†Ô∏è Fichier vide', 'error');
                return;
            }
            odooFileData = data;
            availableColumns = Object.keys(data[0]);
            console.log('Colonnes:', availableColumns);
            
            const s1 = document.getElementById('odooRefColumnSelect');
            const s2 = document.getElementById('supplierRefColumnSelect');
            s1.innerHTML = '<option value="">-- S√©lectionnez --</option>';
            s2.innerHTML = '<option value="">-- S√©lectionnez --</option>';
            
            availableColumns.forEach(col => {
                s1.innerHTML += `<option value="${col}">${col}</option>`;
                s2.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            autoSelectColumns(s1, s2);
            document.getElementById('columnSelectors').classList.remove('hidden');
            showAlert(`‚úÖ ${data.length} produits | ${availableColumns.length} colonnes`, 'success');
        }

        function autoSelectColumns(s1, s2) {
            const p1 = ['default_code', 'internal', 'r√©f√©rence', 'reference'];
            const p2 = ['supplier', 'vendor', 'fournisseur', 'code produit'];
            availableColumns.forEach(col => {
                const lower = col.toLowerCase();
                if (!s1.value) {
                    for (let p of p1) {
                        if (lower.includes(p)) {
                            s1.value = col;
                            break;
                        }
                    }
                }
                if (!s2.value) {
                    for (let p of p2) {
                        if (lower.includes(p)) {
                            s2.value = col;
                            break;
                        }
                    }
                }
            });
            updateMappingPreview();
        }

        function updateMappingPreview() {
            const c1 = document.getElementById('odooRefColumnSelect').value;
            const c2 = document.getElementById('supplierRefColumnSelect').value;
            if (!c1 || !c2) return;
            
            const body = document.getElementById('mappingPreviewBody');
            body.innerHTML = '';
            let count = 0;
            
            for (let i = 0; i < Math.min(5, odooFileData.length); i++) {
                const row = odooFileData[i];
                const sup = String(row[c2] || '').replace('.0', '').trim();
                const odoo = String(row[c1] || '').replace('.0', '').trim();
                if (sup && odoo) {
                    body.innerHTML += `<tr><td>${sup}</td><td style="text-align:center;">‚Üí</td><td>${odoo}</td></tr>`;
                    count++;
                }
            }
            
            if (count > 0) {
                document.getElementById('mappingPreview').classList.remove('hidden');
            } else {
                showAlert('‚ö†Ô∏è Aucune correspondance', 'warning');
            }
        }

        function applyMapping() {
            const c1 = document.getElementById('odooRefColumnSelect').value;
            const c2 = document.getElementById('supplierRefColumnSelect').value;
            if (!c1 || !c2) {
                showAlert('‚ö†Ô∏è S√©lectionnez les colonnes', 'error');
                return;
            }
            
            odooMapping = {};
            let count = 0;
            
            odooFileData.forEach(row => {
                const sup = String(row[c2] || '').replace('.0', '').trim();
                const odoo = String(row[c1] || '').replace('.0', '').trim();
                if (sup && odoo) {
                    odooMapping[sup] = odoo;
                    count++;
                }
            });
            
            console.log(`Mapping: ${count} entr√©es`);
            
            if (count === 0) {
                showAlert('‚ùå Aucun mapping cr√©√©', 'error');
                return;
            }
            
            let mapped = 0, unmapped = 0;
            mappedData = ordersData.map(row => {
                const shopRef = String(row.product_ref_shopware).trim();
                if (odooMapping[shopRef]) {
                    row.product_ref_odoo = odooMapping[shopRef];
                    mapped++;
                } else {
                    unmapped++;
                }
                return row;
            });
            
            document.getElementById('mappingStats').classList.remove('hidden');
            document.getElementById('statMapping').innerHTML = `
                <div class="stat-box"><div class="stat-number">${mapped}</div><div class="stat-label">Mapp√©s</div></div>
                <div class="stat-box"><div class="stat-number">${unmapped}</div><div class="stat-label">Non mapp√©s</div></div>
            `;
            
            // Afficher la section import
            document.getElementById('importSection').classList.remove('hidden');
            
            showAlert(`‚úÖ ${mapped} produits mapp√©s !`, 'success');
        }

        async function importToOdoo() {
            const apiUrl = document.getElementById('apiUrl').value.trim() || localStorage.getItem('apiUrl');
            const odooUrl = document.getElementById('odooUrl').value.trim();
            const odooDb = document.getElementById('odooDb').value.trim();
            const odooUsername = document.getElementById('odooUsername').value.trim();
            const odooApiKey = document.getElementById('odooApiKey').value.trim();
            
            // Options avanc√©es
            const orderTag = document.getElementById('orderTag').value.trim();
            const defaultCarrier = document.getElementById('defaultCarrier').value.trim();
            const defaultWarehouse = document.getElementById('defaultWarehouse').value.trim();
            const orderNote = document.getElementById('orderNote').value.trim();
            const orderPrefix = document.getElementById('orderPrefix').value.trim();
            const autoConfirm = document.getElementById('autoConfirm').checked;

            if (!apiUrl) {
                showAlert('‚ö†Ô∏è API non configur√©e', 'error');
                return;
            }

            if (!odooUrl || !odooDb || !odooUsername || !odooApiKey) {
                showAlert('‚ö†Ô∏è Compl√©tez tous les champs Odoo', 'error');
                return;
            }

            if (mappedData.length === 0) {
                showAlert('‚ö†Ô∏è Aucune donn√©e √† importer. Appliquez d\'abord le mapping.', 'error');
                return;
            }

            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Import en cours...';

            const prog = document.getElementById('importProgress');
            const fill = document.getElementById('importProgressFill');
            prog.classList.remove('hidden');
            fill.style.width = '30%';

            try {
                const res = await fetch(`${apiUrl}/import-to-odoo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orders: mappedData,
                        odoo_url: odooUrl,
                        odoo_db: odooDb,
                        odoo_username: odooUsername,
                        odoo_api_key: odooApiKey,
                        // Options avanc√©es
                        order_tag: orderTag,
                        default_carrier: defaultCarrier ? parseInt(defaultCarrier) : null,
                        default_warehouse: defaultWarehouse ? parseInt(defaultWarehouse) : null,
                        order_note: orderNote,
                        order_prefix: orderPrefix,
                        auto_confirm: autoConfirm
                    })
                });

                fill.style.width = '70%';
                const data = await res.json();
                fill.style.width = '100%';

                if (data.success) {
                    document.getElementById('importStats').classList.remove('hidden');
                    document.getElementById('statsImport').innerHTML = `
                        <div class="stat-box"><div class="stat-number">${data.imported}</div><div class="stat-label">Cr√©√©es</div></div>
                        <div class="stat-box"><div class="stat-number">${data.errors_count}</div><div class="stat-label">Erreurs</div></div>
                        <div class="stat-box"><div class="stat-number">${data.total_orders}</div><div class="stat-label">Total</div></div>
                    `;

                    let msg = `Import termin√©: ${data.imported}/${data.total_orders} commandes cr√©√©es`;
                    if (data.errors_count > 0) {
                        msg += `<br><br>‚ö†Ô∏è ${data.errors_count} erreur(s) - Consultez le rapport d√©taill√© ci-dessous`;
                    }
                    
                    // Afficher les d√©tails dans la console
                    console.log('D√©tails import:', data);
                    
                    // Afficher le rapport d√©taill√©
                    displayImportReport(data, odooUrl);
                    
                    showAlert(msg, data.errors_count === 0 ? 'success' : 'warning', 0); // 0 = ne dispara√Æt jamais
                } else {
                    showAlert(`Erreur: ${data.error}`, 'error', 0);
                    console.error('Erreur import:', data);
                }
            } catch (err) {
                showAlert(`‚ùå ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üéØ Importer dans Odoo';
                setTimeout(() => {
                    prog.classList.add('hidden');
                    fill.style.width = '0%';
                }, 2000);
            }
        }

        function downloadExcel() {
            const data = mappedData.length > 0 ? mappedData : ordersData;
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Commandes');
            const ts = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
            const name = mappedData.length > 0 ? `shopware_odoo_mappe_${ts}.xlsx` : `shopware_odoo_${ts}.xlsx`;
            XLSX.writeFile(wb, name);
            showAlert('üíæ T√©l√©charg√© !', 'success');
        }

        function displayImportReport(data, odooUrl) {
            document.getElementById('importReport').classList.remove('hidden');
            
            // Section succ√®s
            if (data.created_orders && data.created_orders.length > 0) {
                document.getElementById('successSection').classList.remove('hidden');
                const tbody = document.getElementById('successTableBody');
                tbody.innerHTML = '';
                
                data.created_orders.forEach(order => {
                    const productsNotFound = order.products_not_found && order.products_not_found.length > 0 
                        ? order.products_not_found.join(', ') 
                        : '-';
                    
                    const odooLink = `${odooUrl}/web#id=${order.odoo_id}&model=sale.order&view_type=form`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${order.order_number}</td>
                            <td><strong>${order.odoo_id}</strong></td>
                            <td>-</td>
                            <td>${order.lines_count}</td>
                            <td style="color: ${productsNotFound === '-' ? '#28a745' : '#856404'};">${productsNotFound}</td>
                            <td><a href="${odooLink}" target="_blank" style="color: #667eea;">üîó Ouvrir</a></td>
                        </tr>
                    `;
                });
            }
            
            // Section erreurs
            if (data.errors && data.errors.length > 0) {
                document.getElementById('errorSection').classList.remove('hidden');
                const tbody = document.getElementById('errorTableBody');
                tbody.innerHTML = '';
                
                data.errors.forEach(error => {
                    const parts = error.split(': ');
                    const orderNum = parts[0] || 'Inconnu';
                    const errorMsg = parts.slice(1).join(': ') || error;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${orderNum}</strong></td>
                            <td style="color: #721c24;">${errorMsg}</td>
                        </tr>
                    `;
                });
            }
            
            // Section probl√®mes de mapping
            const mappingIssues = {};
            if (data.created_orders) {
                data.created_orders.forEach(order => {
                    if (order.products_not_found && order.products_not_found.length > 0) {
                        order.products_not_found.forEach(ref => {
                            // Trouver les infos du produit dans mappedData
                            const productInfo = mappedData.find(item => 
                                item.product_ref_odoo === ref || item.product_ref_shopware === ref
                            );
                            
                            const key = productInfo ? productInfo.product_ref_shopware : ref;
                            
                            if (!mappingIssues[key]) {
                                mappingIssues[key] = {
                                    shopware_ref: key,
                                    odoo_ref: productInfo ? productInfo.product_ref_odoo : ref,
                                    product_name: productInfo ? productInfo.product_name : '-',
                                    count: 0
                                };
                            }
                            mappingIssues[key].count++;
                        });
                    }
                });
            }
            
            if (Object.keys(mappingIssues).length > 0) {
                document.getElementById('mappingIssuesSection').classList.remove('hidden');
                const tbody = document.getElementById('mappingTableBody');
                tbody.innerHTML = '';
                
                // Trier par nombre d'occurrences d√©croissant
                const sorted = Object.values(mappingIssues).sort((a, b) => b.count - a.count);
                
                sorted.forEach(issue => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${issue.shopware_ref}</strong></td>
                            <td><code>${issue.odoo_ref}</code></td>
                            <td>${issue.product_name}</td>
                            <td><span style="background: #ffc107; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold;">${issue.count}</span></td>
                        </tr>
                    `;
                });
                
                // Sauvegarder pour le t√©l√©chargement
                window.mappingIssuesData = sorted;
            }
        }

        function downloadMappingIssues() {
            if (!window.mappingIssuesData || window.mappingIssuesData.length === 0) {
                showAlert('‚ö†Ô∏è Aucun probl√®me de mapping √† t√©l√©charger', 'warning');
                return;
            }
            
            const data = window.mappingIssuesData.map(issue => ({
                'R√©f√©rence Shopware': issue.shopware_ref,
                'R√©f√©rence Odoo (tent√©e)': issue.odoo_ref,
                'Nom produit': issue.product_name,
                'Nombre d\'occurences': issue.count,
                'Action requise': 'V√©rifier/corriger le mapping dans la base Odoo'
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits non mapp√©s');
            
            const ts = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `produits_non_mappes_${ts}.xlsx`);
            showAlert('üíæ Liste des produits non mapp√©s t√©l√©charg√©e !', 'success');
        }

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('apiUrl');
            if (saved) document.getElementById('apiUrl').value = saved;
        });
    </script>
</body>
</html>
